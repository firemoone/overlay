<html>
<head>
	<title>Parser</title>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
	<meta http-equiv="Cache-Control" content="no-cache, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<meta name="robots" content="noindex, nofollow"/>
	<meta name="googlebot" content="noindex, nofollow"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<style>
		@font-face{ 
			font-family: 'voltage';
			src: url(resources/voltage.woff);
		}
		
		@font-face{ 
			font-family: 'aeromatics';
			src: url(resources/aeromatics.woff);
		}
		
		canvas{
			margin: 0 auto;
		}

		body, html {
			margin: 0;
			overflow: hidden;
			background: none;
			-webkit-user-select: none;
		}
		
		#menu {
			background-color: rgba(0,0,0,.3);
			position: absolute;
			left: 0;
			width: 24px;
			height: 50px;
		}
		
		#more {
			text-align: center;
			margin-top: -15px;
			margin-left: 4px;
			font-family: "voltage";
			font-size: 80px;
			line-height: 12px;
			color: white;
			text-shadow: -1px 0 2px #333, 0 1px 2px #333, 1px 0 2px #333, 0 -1px 2px #333;
		}
		
		#graph-html {
			position: absolute;
			width: calc(100% - 26px);
			right: 0;
			height: 50px;
			font-family: "aeromatics";
			font-size: 15px;
			color: white;
			text-shadow: -1px 0 2px #333, 0 1px 2px #333, 1px 0 2px #333, 0 -1px 2px #333;
		}
		
		#graph-cont {
			background-color: rgba(0,0,0,.3);
			position: absolute;
			width: calc(100% - 26px);
			right: 0;
			height: 50px;
		}
		
		#header {
			position: absolute;
			width: 100%;
			height: 50px;
		}
		
		#legend {
			background-color: rgba(0,0,0,.3);
			position: absolute;
			height: 15px;
			width: 100%;
			font-family: "aeromatics";
			font-size: 12px;
			color: white;
			text-shadow: -1px 0 2px #333, 0 1px 2px #333, 1px 0 2px #333, 0 -1px 2px #333;
		}
		
		.span-absolute {
			position: absolute;
		}
		
		#main {
			position: absolute;
			display: table-cell;
			vertical-align: bottom;
			height: 100%;
			width: 100%;
		}
		
		#updates-html {
			position: absolute;
			background-color: rgba(0, 0 ,0 , .3);
			font-family: "aeromatics";
			font-size: 13px;
			padding: 5px;
			height: calc(100% - 250px);
			color: white;
			text-shadow: -1px 0 2px #333, 0 1px 2px #333, 1px 0 2px #333, 0 -1px 2px #333;
			overflow-y: scroll;
		}
		
		::-webkit-scrollbar {
		  width: 10px;
		}

		::-webkit-scrollbar-track {
		  background: #333; 
		}
		 
		::-webkit-scrollbar-thumb {
		  background: #888; 
		}

		::-webkit-scrollbar-thumb:hover {
		  background: #fff; 
		}
		
		.playerdiv {
			position: absolute;
			color: white;
			text-shadow: -1px 0 2px #333, 0 1px 2px #333, 1px 0 2px #333, 0 -1px 2px #333;
		}
		
		.player-name {
			position: absolute;
			top: -1;
			left: 25%;
			text-align: left;
			font-family: "voltage";
			letter-spacing: 1px;
			font-size: 17px;
		}
		
		.player-dps-base {
			position: relative;
			width: 25%;
			left: 5;
			top: 1;
			font-family: "voltage";
			font-size: 28px;
			overflow: hidden;
		}
		
		.player-dps-dec {
			position: relative;
			right: -5;
			top: 1;
			font-family: "voltage";
			font-size: 20px;
		}
		
		.player-stat {
			position: absolute;
			font-family: "aeromatics";
			font-size: 12px;
		}
		
		.player-dps-bar {
			position: absolute;
			bottom: 0;
			background:  rgba(255,255,255,.5);
			height: 2px;
		}
		
		.player-effect-cont {
			position: absolute;
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
		
		.player-class-img {
			position: absolute;
			transform: rotate(10deg);
			right: 30%;
			top: -5;
			width: 45px;
			height: 45px;
			opacity: .6;
			background-repeat: no-repeat;
			background-size: 100% 100%;
		}
		
		.player-side-popup {
			position: absolute;
			text-align: center;
			font-family: "voltage";
			font-size: 21px;
			white-space: nowrap;
		}
		
		.bloodsplat {
			width: 30px;
			height: 30px;
			box-shadow: 0px 100px 15px 0px #f00;
			position: absolute;
			opacity: 0.5;
			top: -100px;
		}
		
		.critline {
			position: absolute;
			-webkit-filter: blur(5px);
			-moz-filter: blur(5px);
			-o-filter: blur(5px);
			-ms-filter: blur(5px);
			filter: blur(5px);
			background-color: #fff;
		}
		
		.resizeHandle {
			background-image: url(images/handle.png);
			background-position: bottom right;
			background-repeat: no-repeat;
			box-sizing: border-box;
		}
	</style>
	<script src="lib/jquery-3.4.1.min.js" type="text/javascript"></script>
	<script src="lib/chart.bundle.min.js" type="text/javascript"></script>
	<script src="lib/TweenMax.min.js" type="text/javascript"></script>
	<script src="lib/actwebsocket.js" type="text/javascript"></script>
	<script src="lib/config.js" type="text/javascript"></script>
	<script src="lib/parse.js" type="text/javascript"></script>
	<script src="lib/player.js" type="text/javascript"></script>
</head>
<body>
	<div id="legend">
	</div>
	<div id="header">
		<div id="graph-cont">	
			<canvas id="graph" height="50" width="100%"></canvas>
		</div>
		<div id="graph-html">
		</div>
		<div id="menu">
			<p id="more">.<br />.<br />.</p>
		</div>
	</div>
	<div id="main">
	</div>
	<div id="updates-html">
		<span style="font-family: voltage; font-size: 20px;">rev.11</span><br />
		- ACTWebSocket support<br />
		- Catch-all if settings fail to load<br />
		<span style="font-family: voltage; font-size: 20px;">rev.10 (The <span style="color: red">c</span><span style="color: dodgerblue">o</span><span style="color: limegreen">l</span><span style="color: yellow">o</span><span style="color: darkorchid">r</span> update)</span><br />
		- Less confusing jargon, options is now settings<br />
		- New menu icon<br />
		- Reload/reset moved to Settings -> Save Data<br />
		- Settings for player bar colors<br />
		- Player colors seperated into multiple parts<br />
		- Save & Exit moved to a more visible button<br />
		- Fixed(?) undefined max hits<br />
		- Total DPS can no longer be NaN<br />
		- alphaRGBA changed to playerAlpha<br />
		- Various fixes and tweaks<br />
		- Update text has a shadow now too<br />
		- Expect bugs but it'd be nice if this just worked right out of the box<br />
		<span style="font-family: voltage; font-size: 20px;">rev.9</span><br />
		- Menu icons hide during combat, on by default<br />
		- disableMaxHit changed to showMaxhits<br />
		- All if not, most current effects can now be turned on or off<br />
		- Various css tweaks<br />
		<span style="font-family: voltage; font-size: 20px;">rev.8</span><br />
		- Several severe resizing bugs fixed<br />
		- Correction in update notes, saves are done through localstorage not cookies<br />
		<span style="font-family: voltage; font-size: 20px;">rev.7 (The scroll down for more, update)</span><br />
		- Disable clickthru temporarily to scroll and click things<br />
		- Scrollable updates<br />
		- UI recalculated on startup, you may need to resize<br />
		- Config/options framework, disable clickthrough on overlay plugin to use<br />
		- Config/options are saved with localstorage, I'll try my best to not have them reset with every update but no promises<br />
		- Default layout changed (top and left), enter options for the old layout (bottom and right)<br />
		- Config button added to UI<br />
		- Reload/Reboot button added to UI(Click X to hard reset the UI, this is temporary)<br />
		- Basic general options added for debugging<br />
		- Basic layout options added for debugging<br />
		- Basic effect options added for debugging<br />
		- Basic options saving functionality added<br />
		- Various fixes to effects to take into account resizing<br />
		- More performance tweaks<br />
		<span style="font-family: voltage; font-size: 20px;">rev.6</span><br />
		- Added GSAP library, even more performance improvement<br />
		- Improved death effect<br />
		<span style="font-family: voltage; font-size: 20px;">rev.5</span><br />
		- Performance fixes<br />
		<span style="font-family: voltage; font-size: 20px;">rev.4</span><br />
		- Critical hits will flash a display over player containers<br />
		<span style="font-family: voltage; font-size: 20px;">rev.3</span><br />
		- Graph fixes<br />
		<span style="font-family: voltage; font-size: 20px;">rev.2</span><br />
		- Better letter spacing for the reduced containers<br />
		<span style="font-family: voltage; font-size: 20px;">rev.1</span><br />
		- Displays revisions and updates on startup<br />
		- Player container size reduced from 35px to 30px, temporary<br />
		- Fix (maybe) for wrong color displayed when players are generated<br />
		- Performance tweaks
	</div>
<script>
	'use strict';
	// Config things
	var config = new Config();
	try {
		// Is there a saved config?
		if (localStorage.getItem('config') === null) {
			localStorage.setItem('config', JSON.stringify(config)); // There you go
		} else {
			var parseConfig = JSON.parse(localStorage.getItem('config'));
			config.update(parseConfig); // Populate the current config with saved values
			localStorage.setItem('config', JSON.stringify(config)); // Save everything in case there's something new
		}
	} catch (e) {
		// Something is probably broken. Reset settings.
		localStorage.setItem('config', JSON.stringify(config)); // There you go
	}
	
	// Check if configuration is saved
	localStorage.setItem('config-saved', false);
	setInterval(function(){	
		if (localStorage.getItem('config-saved') == "true") {
			location.reload(); // Hard reload the parser - for now
		}
	}, 500);
	
	var updates = true;
	var players = [];
	var activeGate = false;
	var topDamage = 0;

	var ctx = document.getElementById('graph').getContext('2d');
	var graphCanvas = new Chart(ctx, 
		{
			type: 'line',
			data: {
				labels: [1],
				datasets: [{
					data: [0],
					backgroundColor: config.graphFillColor,
					borderColor: config.graphLineColor,
					borderWidth: 2
				}]
			},
			options:{
				responsive: true,
				maintainAspectRatio: false,
				elements: {
					line: {
						tension: 0
					},
					point:{
						radius: 0
					}
				},
				legend: {
					display: false
				},
				scales: {
					xAxes: [{
						display: false
					}],
					yAxes: [{
						display: false
					}]
				},
				tooltips: {
					 enabled: false
				},
				hover: {
					mode: null
				}
			}
		}
	);
	
	// Initial setup
	
	// Container background and text colors
	document.getElementById('legend').style.color = config.infoTextColor;
	document.getElementById('legend').style.backgroundColor = config.infoColor;
	
	document.getElementById('graph-html').style.color = config.graphTextColor;
	document.getElementById('graph-cont').style.backgroundColor = config.graphColor;
	document.getElementById('more').style.color = config.graphTextColor;
	document.getElementById('menu').style.backgroundColor = config.graphColor;
	
	// Should containers fill the main window?
	if (config.graphFill) {
		document.getElementById('header').style.width = '100%';
	} else {
		document.getElementById('header').style.width = 'calc(100% - 100px)';
	}
	if (config.playerFill) {
		document.getElementById('legend').style.width = '100%';
		document.getElementById('updates-html').style.width = 'calc(100% - 10px)';
	} else {
		document.getElementById('legend').style.width = 'calc(100% - 100px)';
		document.getElementById('updates-html').style.width = 'calc(100% - 110px)';
	}
	
	// Vertical and horizontal layout setup
	if (config.layoutVertical) {
		document.getElementById('header').style.top = '0';
		document.getElementById('legend').style.top = '53';
		document.getElementById('main').style.top = '68';
		document.getElementById('updates-html').style.top = '71';
	} else {
		document.getElementById('header').style.bottom = '0';
		document.getElementById('legend').style.bottom = '53';
		document.getElementById('main').style.bottom = '68';
		document.getElementById('updates-html').style.bottom = '71';
	}
	
	if (config.layoutHorizontal) {
		document.getElementById('header').style.left = '0';
		document.getElementById('legend').style.left = '0';
		document.getElementById('main').style.left = '0';
		document.getElementById('updates-html').style.left = '0';
	} else {
		document.getElementById('header').style.right = '0';
		document.getElementById('legend').style.right = '0';
		document.getElementById('main').style.right = '0';
		document.getElementById('updates-html').style.right = '0';
	}
	
	
	// Create menu
	let settingsWin = null;
	$('#menu').click(function(){
		settingsWin = window.open('settings.html', 'oWin', 'width=700, height=400,  resizable=no');
	});
	
	// Event listener from ACT
	document.addEventListener("onOverlayDataUpdate", function (e) {
		update(e.detail);
	});
	
	// UPDATE
	var debug = "";
	var debug2 = "";
	function update(rawdata) {
		var data = new Data(rawdata);
		debug = date;
		debug2 = rawdata;
		
		// Display Legend
		var ele = document.getElementById('legend');
		var legendhtml = "";
		legendhtml += '<span class="span-absolute" style="left: 2; top: 1;">DPS</span>';
		legendhtml += '<span class="span-absolute" style="left: 25%; margin-left: 3px; top: 1;">CRIT</span>';
		legendhtml += '<span class="span-absolute" style="left: 40%; margin-left: 3px; top: 1;">DHIT</span>';
		legendhtml += '<span class="span-absolute" style="left: 55%; margin-left: 3px; top: 1;">!!!</span>';
		legendhtml += '<span class="span-absolute" style="left: 70%; margin-left: 3px; top: 1;">DEATHS</span>';
		legendhtml += '<span class="span-absolute" style="right: 2; margin-left: 3px; top: 1; text-align: right;">MAXHIT</span>';
		ele.innerHTML = legendhtml;
		
		// Update encounter data
		var ele = document.getElementById('graph-html');
		var graphhtml = "";
		var encounterDPS = 0;
		if (!isNaN(data.Encounter['dps'])) {
			encounterDPS = data.Encounter['dps'];
		}
		graphhtml += '<span class="span-absolute" style="left: 2; top: 0;">Total DPS: ' + encounterDPS + '</span>';
		graphhtml += '<span class="span-absolute" style="left: 2; bottom: 0;">Time: ' + data.Encounter['duration'] + '</span>';
		graphhtml += '<span class="span-absolute" style="right: 2; top: 0; text-align: right;">' + data.Encounter['title'] + '</span>';
		ele.innerHTML = graphhtml;

		// Is the data gate primed?
		if (!activeGate) {
			activeGate = true;
			
			// Clear the ui
			var ele = document.getElementById('main');
			while (ele.firstChild) {
				ele.removeChild(ele.firstChild);
			}
			
			graphCanvas.clear();
			graphCanvas.destroy();
			$('#graph').remove();
			$('#graph-cont').append('<canvas id="graph" height="50" width="100%"><canvas>');
			ctx = document.getElementById('graph').getContext('2d');
			graphCanvas = new Chart(ctx, 
				{
					type: 'line',
					data: {
						labels: [1],
						datasets: [{
							data: [0],
							backgroundColor: config.graphFillColor,
							borderColor: config.graphLineColor,
							borderWidth: 2
						}]
					},
					options:{
						responsive: true,
						maintainAspectRatio: false,
						elements: {
							line: {
								tension: 0
							},
							point:{
								radius: 0
							}
						},
						legend: {
							display: false
						},
						scales: {
							xAxes: [{
								display: false
							}],
							yAxes: [{
								display: false
							}]
						},
						tooltips: {
							 enabled: false
						},
						hover: {
							mode: null
						}
					}
				}
			);
			graphCanvas.update();
			
			// Hide menu items during combat
			if (config.hideMenu) {
				document.getElementById('menu').style.display = 'none';
				document.getElementById('graph-html').style.width = '100%';
				document.getElementById('graph-cont').style.width = '100%';
			}
			
			// Remove updates, done once
			if (updates) {
				updates = false;
				$('#updates-html').remove();
			}
		}
		
		//if (true) {
		if (data.isActive == "true") {
			// Check for new players
			for (let e in data.Combatant) {
				let entry = data.Combatant[e];
				if (inArrayKey(players, 'name', entry['name']) == false && Player.isValid(entry)) {
					// Make a new player entry
					let newPlayer = new Player(entry);
					newPlayer.divID = players.length;
					
					switch (newPlayer.role) {
						case "dps":
							newPlayer.divRGBA = config.dpsRGBA;
							newPlayer.divRGBA_ = config.dpsRGBA_;
							newPlayer.divRGBA__ = config.dpsRGBA__;
							break;
						case "tank":
							newPlayer.divRGBA = config.tankRGBA;
							newPlayer.divRGBA_ = config.tankRGBA_;
							newPlayer.divRGBA__ = config.tankRGBA__;
							break;
						case "healer":
							newPlayer.divRGBA = config.healerRGBA;
							newPlayer.divRGBA_ = config.healerRGBA_;
							newPlayer.divRGBA__ = config.healerRGBA__;
							break;
						case "limit break":
							newPlayer.divRGBA = config.limitRGBA;
							newPlayer.divRGBA_ = config.limitRGBA_;
							newPlayer.divRGBA__ = config.limitRGBA__;
							break;
						default:
							newPlayer.divRGBA = config.defaultRGBA;
							newPlayer.divRGBA_ = config.defaultRGBA_;
							newPlayer.divRGBA__ = config.defaultRGBA__;
					}
					
					// Make a new div element
					let newEle = document.createElement("div");
					newEle.setAttribute('id', newPlayer.divID);
					newEle.setAttribute('class', 'playerdiv');
					
					if (config.playerFill) {
						newEle.style.width = '100%';
						if (config.layoutHorizontal) {
							newEle.style.left = '-100%';
						} else {
							newEle.style.right = '-100%';
						}
					} else {
						newEle.style.width = 'calc(100% - 100px)';
						if (config.layoutHorizontal) {
							newEle.style.left = 'calc(-100% + 100px)';
						} else {
							newEle.style.right = 'calc(-100% + 100px)';
						}
					}
					
					if (config.layoutVertical) {
						newEle.style.top = '3';
					} else {
						newEle.style.bottom = '0';
					}
					
					newEle.style.height = '30px';
					newEle.style.background = 'linear-gradient(90deg, ' + newPlayer.divRGBA + ' 0%, ' + newPlayer.divRGBA__ + ' 50%)';
					newEle.style.boxShadow = '2px 3px 4px rgba(0, 0, 0, ' + config.playerAlpha + ')';
					newEle.style.color = config.playerTextColor;
					
					var eleHTML = '';
					
					eleHTML += '<div class="player-effect-cont" style="box-shadow: inset 0 0 10px ' + newPlayer.divRGBA_ + ';"><div class="player-class-img" style="background-image: url(images/' + newPlayer.job + '.png);"></div></div>';
					eleHTML += '<span class="player-name">' + newPlayer.name + '</span>';
					eleHTML += '<span class="player-dps-base" style="color: ' + config.playerDPSColor + '">' + newPlayer.dpsbase + '</span><span class="player-dps-dec" style="color: ' + config.playerDPSColor + '">.' + newPlayer.dpsdec + '</span>';
					eleHTML += '<span class="player-stat crit" style="left: 25%; bottom: 1; margin-left: 3px;">' + newPlayer.crit + '</span>';
					eleHTML += '<span class="player-stat dhit" style="left: 40%; bottom: 1; margin-left: 3px;">' + newPlayer.dhit + '</span>';
					eleHTML += '<span class="player-stat critdhit" style="left: 55%; bottom: 1; margin-left: 3px;">' + newPlayer.critdhit + '</span>';
					eleHTML += '<span class="player-stat deaths" style="left: 70%; bottom: 1; margin-left: 3px;">' + newPlayer.deaths + '</span>';
					eleHTML += '<span class="player-stat maxhit" style="right: 0; bottom: 1; margin-right: 5px; text-align: right;">' + newPlayer.maxhit + '<br />' + newPlayer.maxhitnum + '</span>';
					eleHTML += '<div class="player-dps-bar"></div>';
					
					newEle.innerHTML = eleHTML;
					
					document.getElementById('main').appendChild(newEle);
					players.push(newPlayer);
					
					/*Debug*/
					$('#'+newPlayer.divID).click(function(){ 
						//newPlayer.displaymaxhit = true;
						//newPlayer.displaycrit = true;
						//newPlayer.state = 'dead';
					});
				}
			}

			// Update and sort players and relevant data
			topDamage = 0;
			for (let p in players) {
				players[p].update(data.Combatant);
				if (parseFloat(players[p].dps) > topDamage) topDamage = parseFloat(players[p].dps);
			}
			players.sort(function(a, b) {
				return a.dps - b.dps;
			});
			if (config.layoutVertical) players.reverse();
			
			// Animation
			for (let d in players) {
				// Update div elements
				let ele = document.getElementById(players[d].divID);
				var dpsbarwidth = (parseFloat(players[d].dps)/topDamage) * 100;
				
				$('#' + players[d].divID + ' .player-dps-base').text(players[d].dpsbase);
				$('#' + players[d].divID + ' .player-dps-dec').text('.' + players[d].dpsdec);
				$('#' + players[d].divID + ' .player-stat.crit').text(players[d].crit);
				$('#' + players[d].divID + ' .player-stat.dhit').text(players[d].dhit);
				$('#' + players[d].divID + ' .player-stat.critdhit').text(players[d].critdhit);
				$('#' + players[d].divID + ' .player-stat.deaths').text(players[d].deaths);
				$('#' + players[d].divID + ' .player-stat.maxhit').html(players[d].maxhit + '<br />' + players[d].maxhitnum);
				$('#' + players[d].divID + ' .player-dps-bar').width(dpsbarwidth + '%');
				
				if (config.layoutHorizontal) {
					$('#' + players[d].divID + ' .player-dps-bar').css('left', '0');
				} else {
					$('#' + players[d].divID + ' .player-dps-bar').css('right', '0');
				}
				
				// Alive
				if (players[d].state == "alive") {
					// Maxhit effect
					if (players[d].displaymaxhit == true && config.showMaxhits && !config.playerFill) {
						players[d].displaymaxhit = false;
						var num = Math.floor(Math.random()*5) + 1;
						num *= Math.floor(Math.random()*2) == 1 ? 1 : -1;
						let sidepop = document.createElement("div");
						sidepop.setAttribute('id', 'maxhit' + players[d].divID + Date.now());
						sidepop.setAttribute('class', 'player-side-popup');
						sidepop.style.transform = 'rotate(' + num + 'deg)';
						sidepop.innerHTML = players[d].maxhit + '<br />' + players[d].maxhitnum;
						sidepop.style.top = -10;
						document.getElementById(players[d].divID).appendChild(sidepop);
						var sideOffset = '';
						if (config.layoutHorizontal) {
							sideOffset = $(sidepop, this).width()/2 * -1;
							sidepop.style.right = sideOffset - 40;
							sideOffset = (sideOffset/2) - 40;
							$(sidepop).delay(1500).animate({ // JQuery does this better
								'opacity' : 0,
								'height': '50%',
								'width': '15%',
								'top': "25%",
								'right': sideOffset,
								'fontSize': '50%'
							}, 500, function(e){
								$(sidepop).remove();
							});
						} else {
							sideOffset = $(sidepop, this).width()/2 * -1;
							sidepop.style.left = sideOffset - 40;
							sideOffset = sideOffset/2 - 40;
							$(sidepop).delay(1500).animate({ // JQuery does this better
								'opacity' : 0,
								'height': '50%',
								'width': '15%',
								'top': "25%",
								'left': sideOffset,
								'fontSize': '50%'
							}, 500, function(e){
								$(sidepop).remove();
							});
						}
						
						/*TweenMax.to(sidepop, 0.5, {
							top: "20%",
							left: sideleft,
							height: '50%',
							width: '50%',
							opacity: '0',
							fontSize: '50%',
							delay: '1.5',
						});
						setTimeout(function(){
							$(sidepop, this).remove();
						}, 2000);*/
					}
					
					// Crit effect
					if (players[d].displaycrit == true && config.critBlip) {
						players[d].displaycrit = false;
						let critwave1 = document.createElement("div");
						critwave1.setAttribute('id', 'crit' + players[d].divID + Date.now());
						critwave1.setAttribute('class', 'critline');
						critwave1.style.right = "0";
						critwave1.style.width = '5px';
						critwave1.style.height = '100%';
						critwave1.style.top = 0;
						critwave1.style.opacity = 0.8;
						document.getElementById(players[d].divID).getElementsByClassName('player-effect-cont')[0].appendChild(critwave1);
						
						TweenMax.to(critwave1, 1, {
							right: '100%',
							ease: Power2.easeOut
						});
						setTimeout(function(){
							$(critwave1, this).remove();
						}, 1000);
					}
				}
				
				// Dead
				if (players[d].state == "dead") {
					players[d].state = "alive";
					if (config.deathColor) {
						let playerRGBA = players[d].divRGBA;
						let playerRGBA_ = players[d].divRGBA_;
						let playerRGBA__ = players[d].divRGBA__;
						ele.style.background = 'linear-gradient(90deg, rgba(200, 200, 200, ' + config.playerAlpha + ') 0%, rgba(0,0,0,' + config.playerAlpha + ') 50%)';
						ele.getElementsByClassName('player-effect-cont')[0].style.boxShadow = 'inset 0 0 10px rgba(200, 200, 200, ' + config.playerAlpha + ')';
						
						TweenMax.to(ele, 3, {
							background: 'linear-gradient(90deg, ' + playerRGBA + ' 0%, ' + playerRGBA__ + ' 50%)',
							delay: '2'
						});
						TweenMax.to(ele.getElementsByClassName('player-effect-cont')[0], 3, {
							boxShadow: 'inset 0 0 10px ' + playerRGBA_,
							delay: '2'
						});
					}
					
					if (config.deathShake) {
						TweenMax.fromTo(ele, 4, { rotation: 0.5}, {rotation: 0, ease:Elastic.easeOut.config(5, 0.01)});
					}
					
					if (config.deathBlood) {
						for (let i = 0; i < 3; i++) {
						var num = Math.floor(Math.random() * ele.clientWidth);
						var numw = Math.floor(Math.random() * (60 - 5 + 1) + 5);
						var numh = Math.floor(Math.random() * (ele.clientHeight - 5 + 1) + 5);
						let splat = document.createElement('div');
						splat.setAttribute('id', players[d].divID + num + Date.now());
						splat.setAttribute('class', 'bloodsplat');
						splat.style.left = num + 'px';
						splat.style.width = numw + 'px';
						splat.style.height = numh + 'px';
						splat.style.filter = 'url(#splatfilter' + num + ')';
						var NS = "http://www.w3.org/2000/svg";
						var svg = document.createElementNS(NS, 'svg');
						var filter = document.createElementNS(NS, 'filter');
						filter.setAttribute('id', 'splatfilter' + num);
						var feturb = document.createElementNS(NS, 'feTurbulence');
						feturb.setAttribute('type', 'fractalNoise');
						feturb.setAttribute('baseFrequency', '0.1');
						feturb.setAttribute('seed', num);
						var fedisp = document.createElementNS(NS, 'feDisplacementMap');
						fedisp.setAttribute('in', 'SourceGraphic');
						fedisp.setAttribute('scale', '50');
						filter.appendChild(feturb);
						filter.appendChild(fedisp);
						svg.appendChild(filter);
						splat.appendChild(svg);
						ele.appendChild(splat);
						
						TweenMax.to(splat, 3, {
							opacity: '0',
							delay: '2'
						});
						setTimeout(function(){
							$(splat, this).remove();
						}, 5000);
						}
					}
				}
				
				// Always animate sorting
				var divHeight = 30;
				var divOffset = '';
				var curOffset = '';
				
				if (config.layoutVertical) {
					divOffset = (d * divHeight) + (d * 5) + 2;
					curOffset = ele.style.top;
				} else {
					divOffset = (d * divHeight) + (d * 5) + 5;
					curOffset = ele.style.bottom;
				}
				
				if (players[d].state != "initialize" && curOffset != divOffset) {
					if (config.layoutVertical) {
						TweenMax.to(ele, 0.2, {
							top: divOffset + 'px'
						});
					} else {
						TweenMax.to(ele, 0.2, {
							bottom: divOffset + 'px'
						});
					}
				}
				
				// Initialize and move, not animated
				if (players[d].state == "initialize") {
					if (config.layoutVertical) {
						ele.style.top = divOffset + 'px';
					} else {
						ele.style.bottom = divOffset + 'px';
					}
					
					if (config.layoutHorizontal) {
						$(ele, this).animate({ // JQuery does this better
							'left': '0'
						}, 200, function(e){
							players[d].state = "alive";
						});
					} else {
						$(ele, this).animate({ // JQuery does this better
							'right': '0'
						}, 200, function(e){
							players[d].state = "alive";
						});
					}

					/*TweenMax.to(ele, 0.2, {
						right: '0'
					});
					setTimeout(function(){
						players[d].state = "alive";
					}, 200);*/
				}
				
				// Graph updates
				if (players[d].name == "YOU" && players[d].dpsGraph.length % 3 === 0) {
					var graphx = players[d].dpsGraph.length;
					var graphy = players[d].dpsGraph[graphx-1];
					graphCanvas.data.labels.push(graphx);
					graphCanvas.data.datasets.forEach((dataset) => {
						dataset.data.push(graphy);
					});
					graphCanvas.update();
					
				}
			}
		} else {
			// Show menu items during combat
			if (config.hideMenu) {
				document.getElementById('menu').style.display = 'block';
				document.getElementById('graph-html').style.width = 'calc(100% - 26px)';
				document.getElementById('graph-cont').style.width = 'calc(100% - 26px)';
			}
		
			activeGate = false;
			players.length = 0;
			players = [];
		}
	}

function inArrayKey(array, key, value) {
	try{
		for (var i = 0; i < array.length; i++) {
			if (array[i][key] === value) {
				return array[i];
			}
		}
	}catch(error) {
		return false;
	}
    return false;
}

function sortByKey(array, key) {
	return array.sort(function(a, b) {
		var x = parseFloat(a[key]);
		var y = parseFloat(b[key]);
		if(a < b) return -1;
		if(a > b) return 1;
	}).reverse();
}

// Hide and show handle
document.addEventListener("onOverlayStateUpdate", function (e) {
	if (!e.detail.isLocked) {
		document.documentElement.classList.add("resizeHandle");
	} else {
		document.documentElement.classList.remove("resizeHandle");
	}
});
</script>
</body>
</html>